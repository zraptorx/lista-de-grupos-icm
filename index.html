<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema Multi-Grupos ICM</title>
  
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:#fff;color:#111}
    
    /* LOGIN */
    #auth-screen{max-width:350px;margin:60px auto;text-align:center;border:1px solid #ddd;padding:30px;border-radius:15px;box-shadow:0 4px 10px rgba(0,0,0,0.05)}
    #app-screen{display:none}
    
    input.login-input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ccc;box-sizing:border-box}
    
    /* Bot√µes de Login */
    button.login-btn{width:100%;padding:10px;border-radius:8px;border:1px solid #111;background:#f0f0f0;cursor:pointer;margin-top:10px}
    button.google-btn{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;background:#fff;color:#444;cursor:pointer;margin-top:10px;display:flex;align-items:center;justify-content:center;gap:10px;font-weight:bold}
    button.google-btn:hover{background:#f9f9f9}
    
    /* G2 ESTILOS */
    h1{font-size:20px;margin:0 0 6px 0}
    .muted{color:#666;font-size:12px;margin-bottom:10px}
    button,select,input,textarea{padding:10px;font-size:15px;border-radius:8px;border:1px solid #ccc;margin:4px 0;background:#fff}
    button{cursor:pointer}
    button.primary{border-color:#111;background:#f0f0f0}
    button.danger{border-color:#a33;color:#a33}
    button.success{border-color:#16a34a;color:#16a34a}
    
    .topbar{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;padding:12px;border:1px solid #ddd;border-radius:12px;background:#fafafa;margin:12px 0}
    .field{display:flex;flex-direction:column;gap:6px}
    .box{border:1px solid #ddd;border-radius:12px;padding:12px;background:#fff;margin-top:12px}
    textarea{width:100%;min-height:130px;resize:vertical;box-sizing:border-box}
    .small{font-size:12px;color:#666}
    
    /* TABELA */
    .tableWrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;border:1px solid #ddd;border-radius:12px;background:#fff}
    table{border-collapse:collapse;width:max-content;min-width:100%;margin-top:0}
    th,td{border:1px solid #ddd;padding:6px;text-align:center;white-space:nowrap}
    th{background:#f2f2f2;font-size:11px;position:sticky;top:0;z-index:3}
    
    td.day{cursor:pointer}
    td.day:hover{background-color:#f5f5f5}

    th.nameHead, td.name {
      position: sticky; left: 0; z-index: 10; background: #fff !important;
      text-align: left; min-width: 260px; max-width: 260px; border-right: 2px solid #ddd;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    th.nameHead { z-index: 11; background: #f2f2f2 !important; }
    td.name{font-weight:600; display: flex; justify-content: space-between; align-items: center;}
    
    .sun{background:#fff9e6 !important}
    .present{background:#d1f3dc !important}
    .btn-del{color: #a33; border: none; background: none; font-weight: bold; cursor: pointer; font-size:16px}
    
    footer{text-align:center;margin-top:20px;font-size:13px;color:#888}
  </style>
</head>
<body>

<div id="auth-screen">
  <h1>üîê Acesso ICM</h1>
  <p class="small">Entre ou crie uma conta para o seu grupo.</p>
  
  <input type="email" id="email" class="login-input" placeholder="E-mail">
  <input type="password" id="pass" class="login-input" placeholder="Senha (m√≠n. 6 d√≠gitos)">
  
  <button id="btnLogin" class="login-btn">Entrar com E-mail</button>
  
  <button id="btnGoogle" class="google-btn">
    <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z"/><path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg>
    Entrar com Google
  </button>

  <button id="btnReg" style="border:none;text-decoration:underline;background:none;font-size:12px;margin-top:10px;cursor:pointer">Cadastrar com E-mail e Senha</button>
  <footer>Criado por Romulo Peredo</footer>
</div>

<div id="app-screen">
  <div style="display:flex; justify-content:space-between; align-items:center">
    <h1 id="mainTitle">üìã Lista de Presen√ßa</h1>
    <button id="btnLogout" style="font-size:12px; padding:5px 10px">Sair</button>
  </div>
  
  <div class="box">
    <div style="display:flex; gap:10px">
      <input type="text" id="newName" placeholder="NOME DO NOVO MEMBRO" style="flex:1">
      <button id="btnAdd" class="primary">Adicionar</button>
    </div>
  </div>

  <div class="topbar">
    <div class="field" style="flex:2;min-width:200px">
        <div class="small">Nome do Grupo (Ex: Jovens)</div>
        <input id="groupNameInput" type="text" placeholder="Digite o nome do grupo aqui..." style="font-weight:bold; color:#000">
    </div>

    <div class="field"><div class="small">M√™s</div><select id="month"></select></div>
    <div class="field"><div class="small">Ano</div><select id="year"></select></div>
    <div class="field"><div class="small">Dia</div><select id="daySelect"></select></div>
    <div class="field" style="flex:1;min-width:150px"><div class="small">Buscar</div><input id="search" type="text" placeholder="Filtrar..."></div>
    
    <div class="field"><button id="btnPdf" class="primary">PDF</button></div>
    <div class="field"><button id="btnBackup" class="success">‚¨áÔ∏è Backup</button></div>
    <div class="field"><button id="btnRestore" class="success">‚¨ÜÔ∏è Restore</button></div>
    <input type="file" id="fileRestore" style="display:none" accept=".json">
  </div>

  <div class="tableWrap"><table id="table"></table></div>

  <div class="box">
    <button id="btnGenerate" class="primary">Gerar Relat√≥rio Di√°rio</button>
    <button id="btnSendWa" class="success">üì± Enviar WhatsApp</button>
    <textarea id="waText" readonly placeholder="O texto aparecer√° aqui..."></textarea>
  </div>

  <footer>Criado por Romulo Peredo</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBBBkKZcscH0aHZBO0_5ydXpkh4lez9Enc",
    authDomain: "lista-de-grupos-icm.firebaseapp.com",
    projectId: "lista-de-grupos-icm",
    storageBucket: "lista-de-grupos-icm.firebasestorage.app",
    messagingSenderId: "676914873766",
    appId: "1:676914873766:web:25f4aea0809e1f4308fb67"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let people = [], marks = {}, groupConfig = { name: "Lista de Presen√ßa" };
  let currentDocRef, peopleDocRef, configDocRef, unsubP, unsubM, unsubC, userUID;

  const monthSel = document.getElementById("month"), 
        yearSel = document.getElementById("year"), 
        daySel = document.getElementById("daySelect"), 
        table = document.getElementById("table"), 
        searchEl = document.getElementById("search"), 
        waText = document.getElementById("waText"),
        groupNameInput = document.getElementById("groupNameInput"),
        mainTitle = document.getElementById("mainTitle");
        
  const months = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

  months.forEach((m,i)=> monthSel.add(new Option(m,i)));
  monthSel.value = new Date().getMonth();
  for(let y=2024; y<=2026; y++) yearSel.add(new Option(y,y));
  yearSel.value = new Date().getFullYear();

  // --- LOGIN: EMAIL/SENHA ---
  const emailIn = document.getElementById('email');
  const passIn = document.getElementById('pass');

  document.getElementById("btnReg").onclick = async () => {
    if (!emailIn.value || passIn.value.length < 6) return alert("E-mail e senha (6+ d√≠gitos) obrigat√≥rios.");
    try { await createUserWithEmailAndPassword(auth, emailIn.value, passIn.value); alert("Conta Criada! Entrando..."); }
    catch (e) { alert("Erro: " + e.message); }
  };

  document.getElementById("btnLogin").onclick = async () => {
    try { await signInWithEmailAndPassword(auth, emailIn.value, passIn.value); } 
    catch (e) { alert("Erro ao entrar. Verifique dados."); }
  };

  // --- LOGIN: GOOGLE ---
  document.getElementById("btnGoogle").onclick = async () => {
    const provider = new GoogleAuthProvider();
    try {
        await signInWithPopup(auth, provider);
        // O onAuthStateChanged vai cuidar do resto
    } catch (e) {
        alert("Erro no Login Google: " + e.message);
    }
  };

  document.getElementById("btnLogout").onclick = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
    if (user) {
      userUID = user.uid;
      document.getElementById("auth-screen").style.display = "none";
      document.getElementById("app-screen").style.display = "block";
      attachListeners();
    } else {
      document.getElementById("auth-screen").style.display = "block";
      document.getElementById("app-screen").style.display = "none";
      if(unsubP) unsubP(); if(unsubM) unsubM(); if(unsubC) unsubC();
    }
  });

  // --- SISTEMA ---

  async function attachListeners(){
    const y = yearSel.value, m = Number(monthSel.value), mKey = `${y}-${String(m+1).padStart(2,"0")}`;
    
    // Refer√™ncias
    peopleDocRef = doc(db, `usuarios/${userUID}/dados`, "membros");
    configDocRef = doc(db, `usuarios/${userUID}/dados`, "config"); // Novo local para o nome do grupo
    currentDocRef = doc(db, `usuarios/${userUID}/presencas`, mKey);

    // 1. Ouvir Membros
    if(unsubP) unsubP();
    unsubP = onSnapshot(peopleDocRef, snap => { 
        people = snap.exists() ? snap.data().people || [] : []; 
        render(); 
    });

    // 2. Ouvir Presen√ßas
    if(unsubM) unsubM();
    unsubM = onSnapshot(currentDocRef, snap => { 
        marks = snap.exists() ? snap.data().marks || {} : {}; 
        render(); 
    });

    // 3. Ouvir Configura√ß√£o (Nome do Grupo)
    if(unsubC) unsubC();
    unsubC = onSnapshot(configDocRef, snap => {
        if(snap.exists()) {
            groupConfig = snap.data();
            groupNameInput.value = groupConfig.name || "";
            mainTitle.textContent = "üìã " + (groupConfig.name || "Lista de Presen√ßa");
        }
    });

    const days = new Date(y, m+1, 0).getDate();
    daySel.innerHTML = "";
    for(let i=1; i<=days; i++) daySel.add(new Option(i,i));
  }

  // SALVAR NOME DO GRUPO AO MUDAR
  groupNameInput.onchange = async () => {
      const newName = groupNameInput.value.trim();
      if(newName) {
          await setDoc(configDocRef, { name: newName }, { merge: true });
      }
  };

  function render(){
    const y = Number(yearSel.value), m = Number(monthSel.value), days = new Date(y, m+1, 0).getDate();
    const q = (searchEl.value || "").toLowerCase();
    
    let h1 = "<tr><th rowspan='2' class='nameHead'>Nome</th>", h2 = "<tr>";
    for(let d=1; d<=days; d++){
      const isSun = new Date(y, m, d).getDay() === 0;
      if(isSun){ h1 += `<th colspan='2' class='sun'>${d}</th>`; h2 += `<th class='sun'>E</th><th class='sun'>C</th>`; }
      else { h1 += `<th rowspan='2'>${d}</th>`; }
    }
    h1 += "</tr>"; h2 += "</tr>";
    
    let body = "";
    people.filter(p => p.name.toLowerCase().includes(q)).forEach(p => {
      body += `<tr><td class="name"><span>${p.name}</span> <button class="btn-del" onclick="delM('${p.id}')">‚úï</button></td>`;
      for(let d=1; d<=days; d++) {
        const isSun = new Date(y, m, d).getDay() === 0;
        if(isSun){
          const kE = `${p.id}-${d}-E`, kC = `${p.id}-${d}-C`;
          body += `<td class="day sun ${marks[kE]?'present':''}" onclick="toggle('${p.id}',${d},'E')">${marks[kE]?'X':''}</td>`;
          body += `<td class="day sun ${marks[kC]?'present':''}" onclick="toggle('${p.id}',${d},'C')">${marks[kC]?'X':''}</td>`;
        } else {
          const k = `${p.id}-${d}-C`;
          body += `<td class="day ${marks[k]?'present':''}" onclick="toggle('${p.id}',${d},'C')">${marks[k]?'X':''}</td>`;
        }
      }
      body += `</tr>`;
    });
    table.innerHTML = h1 + h2 + body;
  }

  window.toggle = async (pid, d, type) => {
    const id = `${pid}-${d}-${type}`;
    const val = marks[id] ? deleteField() : true;
    const dotPath = `marks.${id}`;
    try {
      await updateDoc(currentDocRef, { [dotPath]: val });
    } catch (e) {
      if (e.code === 'not-found') await setDoc(currentDocRef, { marks: { [id]: true } });
      else alert("Erro: " + e.message);
    }
  };

  window.delM = async (id) => { 
    if(confirm("Remover este membro?")) await setDoc(peopleDocRef, { people: people.filter(p => p.id !== id) }); 
  };

  document.getElementById("btnAdd").onclick = async () => {
    const n = document.getElementById("newName").value.trim().toUpperCase();
    if(n) await setDoc(peopleDocRef, { people: [...people, {id: "p"+Date.now(), name: n}].sort((a,b)=>a.name.localeCompare(b.name)) }, {merge: true});
    document.getElementById("newName").value = "";
  };

  monthSel.onchange = yearSel.onchange = attachListeners;
  searchEl.oninput = render;

  // --- RELAT√ìRIOS USANDO O NOME DO GRUPO ---

  document.getElementById